## ä»€ä¹ˆæ˜¯å‰åç«¯åŒæ„

å‘å±•è¶‹åŠ¿ï¼šå‰åç«¯å¼‚æ„ -> å‰åç«¯åˆ†ç¦» -> å‰åç«¯åŒæ„

### å‰åç«¯å¼‚æ„

> å…¸å‹ä¼ ç»Ÿå•æœºMVCæ¨¡å¼ï¼šJavaWeb + jquery + webæœåŠ¡

#### ç‰¹ç‚¹ï¼š
- å¯æœ‰åˆ©äºSEOï¼Œå°¤å…¶æ˜¯é—¨æˆ·ç½‘ç«™
- å‰åç«¯å¼€å‘é€»è¾‘æ˜¯ä¸€èµ·çš„ï¼Œé€šè¿‡httpåè®®è¿›è¡Œé€šè®¯
- å¯ä»¥ç›´æ¥æ¸²æŸ“å‡ºå¸¦æ•°æ®å’Œæ ·å¼çš„htmlé¡µé¢ï¼Œåœ¨ä½ç½‘é€Ÿå¤šè¯·æ±‚æ•°æ®çš„æƒ…å†µä¸‹ï¼Œå¤§å¤§å¢åŠ ç”¨æˆ·ä½“éªŒ
    - ä½†æ˜¯ï¼Œä»ç„¶éœ€è¦ç­‰å¾…å¼‚æ­¥jsè§£ææ‰§è¡Œï¼Œæ‰å¯ä»¥äº¤äº’
    - åŒæ—¶ï¼Œå¼€å‘ä½“éªŒè¾ƒå·®ï¼Œè™½ç„¶JSPä¹Ÿæ˜¯æ•°æ®é©±åŠ¨ï¼Œä½†æ˜¯ä½†æ˜¯æ¯”è¾ƒäºç°é˜¶æ®µå‰ç«¯MVCæ¡†æ¶è€Œè¨€ï¼Œèƒ½åŠ›ä¸è¶³ï¼ˆæ•°æ®æµæ–¹é¢ï¼‰
    - å¹¶ä¸”ï¼Œå¼‚æ„æ¯æ¬¡è®¿é—®éƒ½éœ€è¦ç»è¿‡æœåŠ¡å™¨ï¼Œé€ æˆä¸€å®šæœåŠ¡å™¨å‹åŠ›ï¼Œå¼€é”€è¾ƒå¤§

### å‰åç«¯åˆ†ç¦»

> ç°é˜¶æ®µé¡¹ç›®æ¨¡å¼ï¼šå‰ç«¯MVC + webæœåŠ¡

#### ç‰¹ç‚¹ï¼š
- SEOä¸å‹å¥½
- å‰åç«¯åœ¨å¼€å‘é€»è¾‘ä¸Šæ˜¯åˆ†å¼€çš„ï¼Œé€šè¿‡httpåè®®è¿›è¡Œé€šè®¯
- éƒ¨ç½²é€»è¾‘å¯ä»¥åˆ†åˆ«é‡‡ç”¨åŒæ—¶éƒ¨ç½² å’Œ æŠŠå‰ç«¯å½“ä½œé™æ€èµ„æºæ”¾åœ¨nginxä¸Šéƒ¨ç½²å¤„ç†
- é¡µé¢æ¸²æŸ“åªèµ°å®¢æˆ·ç«¯æ¸²æŸ“ï¼Œåœ¨ä½ç½‘é€Ÿå¤šè¯·æ±‚æ•°æ®çš„æƒ…å†µä¸‹ï¼Œç”¨æˆ·ä½“éªŒä¸å¥½ï¼Œç”šè‡³é•¿æ—¶é—´ç°å®ç™½å±å¹•

### nodeå‰åç«¯åŒæ„
![SSR](https://github.com/garry-mark/markdownImage/raw/master/ssr/SSR.png)

![CSR](https://github.com/garry-mark/markdownImage/raw/master/ssr/CSR.png)

### åŒºåˆ«ä¸»è¦åœ¨äºå‡ºç°é¦–å±æ¸²æŸ“çš„æ—¶æœº
- å¯¹äºæœåŠ¡å™¨ç«¯æ¸²æŸ“ï¼ˆServer Side Renderï¼Œç®€å†™SSRï¼‰æ¥è¯´
    - æœåŠ¡å™¨è¿”å›çš„æ˜¯ç»“æ„ç›¸å¯¹å®Œæ•´çš„é€šè¿‡è§£é‡Šçš„HTMLæ–‡ä»¶ï¼Œæµè§ˆå™¨å°±èƒ½æ¸²æŸ“å‡ºé¡µé¢
    - æ¢å¥è¯ï¼Œæµè§ˆå™¨å†ä¹Ÿä¸éœ€è¦ç­‰åˆ°æ‰€æœ‰çš„JavaScriptæ–‡ä»¶ä¸‹è½½å¹¶æ‰§è¡Œå®Œä¹‹åæ‰å»æ¸²æŸ“é¡µé¢å•¦ï¼ˆå¢é‡å¼æ„å»ºï¼‰
- è€Œå¯¹å®¢æˆ·ç«¯æ¸²æŸ“ï¼ˆClient Side Renderï¼Œç®€å†™CSRï¼‰æ¥è¯´
    - æµè§ˆå™¨æ‹¿åˆ°çš„åªæ˜¯åŒ…å«JavaScriptä»£ç çš„HTMLæ–‡ä»¶
    - æ¢å¥è¯ï¼Œåœ¨æµè§ˆå™¨æ¸²å¼€å§‹æ¸²æŸ“å‡ºé¡µé¢ä¹‹å‰ï¼Œéœ€è¦åŠ¨æ€åˆ›å»ºHTMLæ ‡ç­¾
    - æ‰€ä»¥ï¼Œæœ‰ç™½å±ç°è±¡ã€‚ä¸ºä»€ä¹ˆä¼šå‡ºç°ç™½å±ï¼Ÿ
        - å› ä¸ºåœ¨è‡ªä¸Šè€Œä¸‹çš„è§£æhtmlæ—¶å€™ï¼Œåœ¨è§£ææ‰§è¡Œjsæ—¶å€™ï¼Œæµè§ˆå™¨æ¸²æŸ“å†…æ ¸ä¼šåœæ­¢æ¸²æŸ“ï¼Œè€Œå¾€å¾€æ ·å¼å’Œå…ƒç´ éƒ½æ˜¯jsåŠ¨æ€æ·»åŠ è¿›å»çš„ã€‚

ä»SSRä»¥åŠCSRçš„æ—¶åºå›¾é‡Œï¼Œæˆ‘ä»¬å¯ä»¥å‘ç°ï¼Œè¿™ä¸¤ç§æ¸²æŸ“æ–¹å¼è¿˜æ˜¯æœ‰è›®å¤šå…±åŒç‚¹çš„ï¼š
- éƒ½éœ€è¦ä¸‹è½½Reactçš„
- éƒ½éœ€è¦ç»å†è™šæ‹ŸDOMæ„å»ºè¿‡ç¨‹
- éƒ½éœ€è¦ï¼ˆç»™é¡µé¢å…ƒç´ ï¼‰ç»‘å®šäº‹ä»¶æ¥å¢å¼ºé¡µé¢çš„å¯äº¤äº’æ€§

> å‰åç«¯åŒæ„ï¼šå‰ç«¯MVC + webæœåŠ¡

#### ç‰¹ç‚¹
- å¯æœ‰åˆ©äºSEOï¼Œå°¤å…¶æ˜¯é—¨æˆ·ç½‘ç«™
- å‰åç«¯å¼€å‘é€»è¾‘æ˜¯ä¸€èµ·ï¼Œé€šè¿‡httpåè®®è¿›è¡Œé€šè®¯
- éƒ¨ç½²é€»è¾‘å¯ä»¥åˆ†åˆ«é‡‡ç”¨åŒæ—¶éƒ¨ç½² å’Œ æŠŠå‰ç«¯å½“ä½œé™æ€èµ„æºæ”¾åœ¨nginxä¸Šéƒ¨ç½²å¤„ç†
- å¯ä»¥ç›´æ¥æ¸²æŸ“å‡ºå¸¦æ•°æ®å’Œæ ·å¼çš„htmlé¡µé¢ï¼Œåœ¨ä½ç½‘é€Ÿå¤šè¯·æ±‚æ•°æ®çš„æƒ…å†µä¸‹ï¼Œå¤§å¤§å¢åŠ ç”¨æˆ·ä½“éªŒ
    - ä½†æ˜¯ç”±äºreactçš„æ•°æ®ç»‘å®šï¼Œä»ç„¶æ— æ³•è¿›è¡Œäº¤äº’
- ä»…é¦–å±æ¸²æŸ“éœ€è¦ç»è¿‡æœåŠ¡å™¨ï¼Œå¼€é”€è¾ƒå°

## ä¸ºä»€ä¹ˆè¦è¿›è¡Œå‰åç«¯åŒæ„

### åˆ†ææ–¹æ¡ˆ

| æ–¹æ¡ˆ       | å¼€å‘ï¼ˆä»£ç ï¼‰é€»è¾‘ | éƒ¨ç½²é€»è¾‘ | ç”¨æˆ·ä½“éªŒ | å¼€å‘éš¾åº¦ | æ€§èƒ½æ¶ˆè€— | SEO
| ---------- | -------- | -------- | -------- | -------- | -------- |
| å‰åç«¯å¼‚æ„ | æ··åˆ     | åŠ¨é™åˆ†ç¦» | å¥½       | é«˜       | é«˜       | å¯ç”¨
| å‰åç«¯åˆ†ç¦» | ç‹¬ç«‹     | åŠ¨é™åˆ†ç¦» | ä¸å¥½     | ä¸­       | ä¸­       | ä¸å¯ç”¨
| å‰åç«¯åŒæ„ | æ··åˆ     | åŠ¨é™åˆ†ç¦» | å¥½       | é«˜       | ä½       | å¯ç”¨

### é€‰æ‹©å‰ç«¯ååŒæ„çš„åŸå› 
- æ€§èƒ½ä¼˜åŒ–ï¼Œå¢å¼ºç”¨æˆ·ä½“éªŒï¼šåˆ©ç”¨Nodeå¤„ç†IOå¯†é›†å‹çš„ä¼˜åŠ¿ï¼Œå®ç°é¦–å±æœåŠ¡ç«¯é¡µé¢æ¸²æŸ“
- å¢åŠ å‰ç«¯å·¥ç¨‹å¸ˆäº§èƒ½ï¼šæŠ€æœ¯ç§¯ç´¯ä¸å±€é™äºé¡µé¢äº¤äº’å¤åˆ¶ç²˜è´´ï¼Œåœ¨ä¸šåŠ¡ã€éƒ¨ç½²è¿ç»´ç­‰æ–¹é¢æ›´å¤šå¯ç”¨æœ‰æ›´å¤šçš„æ¥è§¦å’Œç©ºé—´
- æé«˜æ•ˆç‡ï¼šé™ä½å‰ç«¯å·¥ç¨‹å¸ˆ ä¸ è¿ç»´äººå‘˜ æ²Ÿé€šæˆæœ¬åæé«˜ç”Ÿäº§æ•ˆç‡ï¼Œåœ¨å‰ç«¯çš„ç†è§£ä¸‹ï¼Œæ›´å¥½åœ°å¤„ç†é™æ€èµ„æº

## å¦‚ä½•æ¶æ„å’Œä½¿ç”¨å‰ç«¯ååŒæ„

> å‰ç«¯ååŒæ„çš„æœ¬è´¨ï¼šæ˜¯ä¸€ä¸ªnodeæœåŠ¡ï¼Œæä¾›æœåŠ¡å™¨ç«¯æ¸²æŸ“åŠŸèƒ½ï¼Œä¸å‚ä¸apiã€é™æ€èµ„æºç­‰ç›¸å…³çš„æ“ä½œã€‚å¾—åˆ°é¦–å±åï¼Œè¿›è¡Œå‰ç«¯é™æ€èµ„æºçš„è¯·æ±‚ï¼ˆå‘nginxï¼‰å’ŒåŠ è½½ï¼Œé€šè¿‡å®¢æˆ·ç«¯æ¸²æŸ“æä¾›æœåŠ¡ã€‚

```
git clone https://github.com/garry-mark/my-react-app.git @types

cd my-react-app/ssr-service

npm install

# å¯åŠ¨é¡¹ç›®
npm start

```

### ç›®å½•ç»“æ„
```
- ssr-service
    - .vscode                               # è®°å½•é¡¹ç›®vscodeç‰¹å¾
    - config                                # typescriptå’Œwebpacké…ç½®æ–‡ä»¶
        - webpack.base.conf.ts              # webpackå…¬å…±é…ç½®ï¼Œé…ç½®äº†å…¬å…±çš„webpackçš„loaderå’Œresolveç›¸å…³é…ç½®
        - webpack.browser.dev.conf.ts       # æµè§ˆå™¨å¼€å‘é˜¶æ®µ
        - webpack.browser.prod.conf.ts      # æµè§ˆå™¨ç”Ÿäº§é˜¶æ®µ
        - webpack.dll.conf.ts               # ç¬¬ä¸‰æ–¹ä¾èµ–æ‰“åŒ…
        - webpack.node.base.conf.ts         # nodeå…¬å…±é…ç½®ï¼šä¸»è¦ä½¿ç”¨isomorphic-style-loaderï¼Œä¸nodeåœ¨webpackæ‰“åŒ…çš„ç›¸å…³é…ç½®ï¼ˆå…¶å®nodeå¹¶ä¸éœ€è¦webpackæ‰“åŒ…ï¼‰
        - webpack.node.dev.conf.ts          # nodeå¼€å‘é…ç½®
        - webpack.node.prod.conf.ts         # nodeç”Ÿäº§é…ç½®
        - webpack.prod.conf.ts              # åŒæ„å·¥ç¨‹ç”Ÿäº§ç¯å¢ƒé…ç½®
        - tsconfig.browser.json
        - tsconfig.server.json
    - dist                                  # ç”Ÿæˆéƒ¨ç½²çš„ç›®å½•
        - server
            - main.js                       # ç”Ÿæˆå‹ç¼©åçš„nodeï¼ŒåŒ…å«cssï¼Œreactç»„ä»¶ç­‰èµ„æº
        - static
            - css
                - styles.css
                - styles.css.gz
            - js
                - main.js
                - main.js.gz
            - vendor
                - vendor.dll.js
                - vendor.dll.js.gz
            - favicon.ico
            - favicon.ico.gz
            - index.html
            - index.html.gz
    - log                                   # æœåŠ¡æ—¥å¿—ï¼šåŒ…å«è®¿é—®ã€æ“ä½œã€é”™è¯¯æ—¥å¿—çš„è®°å½•
    - node_module                           # nodeä¾èµ–
    - src
        - api                               # ï¼ˆå¾…å®ç°ï¼‰å¯¹serviceçš„å°è£…ï¼ŒnodeæœåŠ¡è‡ªåŠ¨ç”Ÿæˆ
        - agent                             # åŸºäºaxiosçš„http-client
            - broser-agent.ts
            - index.ts
            - server-agent.ts
        - browser                           # åŸºäºreactå…¨å®¶æ¡¶å‰ç«¯å·¥ç¨‹ç›®å½•
            - actions                       # reduxä¸­çš„actionï¼ŒåŒ…å«æ”¹å˜å½“å‰storeä¸­stateçš„åŒæ­¥actionï¼Œå’Œå‘é€è¯·æ±‚çš„å¼‚æ­¥action
                - aboutme.ts
                - Action.ts
            - components                    # å…¬å…±ç»„ä»¶
                - HOC
                    - withStyles.tsx
                - layout
                - loading
                - status
                    - index.tsx
                    - notFound.tsx
                    - redirect.tsx
                    - serviceErroe.tsx
            - const
                - actionTypes.ts
                - index.ts
            - pages
                - about-me
                    - about-me.css
                    - about-me.css.d.ts
                    - about-me.tsx          # UIç»„ä»¶
                    - index.tsx             # å®¹å™¨ç»„ä»¶
                - app
                    - index.tsx             # å¸ƒå±€æ¡†æ¶å…¥å£ï¼ŒåŒ…å«Layoutä¸‹çš„å¸ƒå±€ç»„ä»¶ä»¥åŠrouterç›¸å…³å®ç°
                - router.config.ts          # é™æ€è·¯ç”±é…ç½®
            - reducers
                - abouteme.ts
            - store
                - index.ts                  # reduxä¸­çš„storeï¼Œæä¾›getStoreæ–¹æ³•ï¼ŒæœåŠ¡ç«¯å’Œæµè§ˆå™¨ä¼šæœ‰ä¸åŒå¤„ç†
            - theme
                - _mixins.css               # æ··åˆç±»
                - _reset.css                # åŸºäºnormalize.cssçš„æ ·å¼é‡è®¾
                - _var.css                  # å˜é‡
                - global.css                # å…¨å±€æ ·å¼
            - index.tsx
        - model
            - Me.ts                         # å‰åç«¯å…¬ç”¨çš„æ•°æ®æ¨¡å‹ï¼ˆä½†ä»…å‰ç«¯ä½¿ç”¨ï¼Œåé¢ä¼šä¿®æ”¹ï¼‰
        - server
            - middleware
                - handleError.ts            # ç¨‹åºå¥å£®æ€§å¤„ç†
                - log4js.ts                 # æ—¥å¿—è®°å½•
                - serverSideRender.tsx      # æœåŠ¡å™¨ç«¯æ¸²æŸ“ä¸­é—´ä»¶
            - app.ts                        # æœåŠ¡ç«¯ä¸­é—´ä»¶æŒ‚è½½
            - index.dev.ts                  # å¼€å‘ç¯å¢ƒå…¥å£ï¼šåŒ…å«webpackå¼€å‘ç¯å¢ƒæœåŠ¡ä¸­é—´ä»¶å’Œçƒ­æ›¿æ¢ä¸­é—´ä»¶
            - index.prod.ts                 # ç”Ÿæˆå…¥å£
        - utils
        - views
            - index.html                    # å¼€å‘ç¯å¢ƒä¸‹æ ¹æ®æ¨¡ç‰ˆç”Ÿæˆçš„html
            - index.tmpl.html               # å•é¡µé¢æ¨¡ç‰ˆæ–‡ä»¶
            - 40x.html
            - 50x.html
    - static                                # å…¶ä»–é™æ€èµ„æºæ–‡ä»¶
         - favicon.ico
    - typings
    - .babelrc
    - Dockerfile
    - ecosystem.config.js                   # pm2å¯åŠ¨æ–‡ä»¶
    - package.json                          # npmåŒ…é…ç½®æ–‡ä»¶
    - tsconfig.json                         # é¡¹ç›®typescripté…ç½®æ–‡ä»¶ï¼ˆæœ‰ç‚¹å¤šä½™ï¼‰
    - tslint.json                           # tslinté…ç½®æ–‡ä»¶
    - vendor-manifest.json                  # ç¬¬ä¸‰æ–¹ä¾èµ–æ˜ å°„æ–‡ä»¶

```
### å¼€å‘é˜¶æ®µ

> ç›®çš„ï¼šå®Œæˆå‰ç«¯å¼€å‘è‡ªåŠ¨åŒ–ï¼Œå³è‡ªåŠ¨æ‰“åŒ…ä¸é‡å¯

#### ä»npm startå¼€å§‹äº†è§£å¦‚ä½•è®¾è®¡

ä»æœ¬è´¨ä¸Šçœ‹åŒæ„å·¥ç¨‹æ˜¯ä¸€ä¸ªnodeæœåŠ¡ï¼Œæ‰€ä»¥npm startå¯åŠ¨çš„æ˜¯ä¸€ä¸ªnodeæœåŠ¡

```json
{
"start": "npm run dev",
"dev": "npm-run-all --parallel dev:**",
"dev:serve": "nodemon ./dist/server/main.js --watch 'dist/server/**/*.*' ",
"dev:build": "webpack --watch --config ./config/webpack.node.dev.conf.ts",

// å¦å¤–æ–¹æ¡ˆ
"dev": "nodemon --watch 'src/server/**/*.*' --exec 'ts-node' src/server/index.dev.ts",
}
```

#### æœåŠ¡ç«¯ä»£ç ä¿®æ”¹åè‡ªåŠ¨é‡å¯
npm start å®é™…ä¸Šæ˜¯devçš„åˆ«åï¼ˆæ¯”npm run devçŸ­ï¼‰ï¼Œdevä½¿ç”¨npm-run-allå¹¶è¡Œæ‰§è¡Œdev:serveå’Œdev:buildä¸¤ä¸ªè„šæœ¬
- dev:build ä¸»è¦æ˜¯ä½¿ç”¨webpackæ‰“åŒ…ï¼Œç”Ÿæˆå¼€å‘é˜¶æ®µçš„æœåŠ¡ç«¯ä»£ç ï¼Œå¹¶æŒç»­ç›‘å¬æœåŠ¡ç«¯ä»£ç è€Œé‡æ–°æ‰“åŒ…
- dev:serve ä¸»è¦æ˜¯ä½¿ç”¨nodemon å¯åŠ¨æ‰“åŒ…åçš„æœåŠ¡ç«¯ä»£ç ï¼Œå¹¶ä¸”ç›‘å¬æ‰“åŒ…åçš„æœåŠ¡ç«¯ä»£ç ï¼Œé‡å¯æœåŠ¡

#### å‰ç«¯ä»£ç çƒ­æ›¿æ¢
æ‰“åŒ…åçš„æœåŠ¡ç«¯ä»£ç ï¼Œæ˜¯ä»¥server/index.dev.tsä¸ºå…¥å£æ–‡ä»¶ï¼Œé‡Œé¢åŒ…å«koa-webpack

``` typescript
import * as path from 'path';
import * as fs from 'fs';
import * as koaWebpack from 'koa-webpack';
import devConfig from '../../config/webpack.browser.dev.conf';
import * as config from '../../app.config';

import app from '@/server/app';

const publicPath = (devConfig.output && devConfig.output.publicPath) || '';
const pathName = (devConfig.output && devConfig.output.path) || '';
const port = process.env.PORT || config.app[process.env.NODE_ENV].port;

// koa-webpackä¼šä»¥æµè§ˆå™¨webpacké…ç½®ï¼ˆwebpack.browser.dev.confï¼‰è¿›è¡Œå‰ç«¯æ‰“åŒ…ï¼Œå¹¶ä¸”æŠŠç”Ÿæˆçš„èµ„æºæ–‡ä»¶æ”¾åœ¨å†…å­˜ä¸­
koaWebpack({
  config: devConfig,
  devMiddleware: {
    publicPath,
    serverSideRender: true
  }
}).then((middleware) => {
  // æŒ‚è½½koa-webpack-Dev-server
  app.use(middleware);

  app.use(async (ctx: any, next: any) => {
    // åœ¨å†…å­˜ä¸­è·å–ç”Ÿæˆçš„index.htmlæ–‡ä»¶ï¼Œè¯¥æ–‡ä»¶åŒ…å«å¯¹å¼€å‘é˜¶æ®µï¼Œå‰ç«¯èµ„æºçš„è¿æ¥ä»¥åŠçƒ­æ›¿æ¢ç›¸å…³ä»£ç 
    const rs = await middleware.devMiddleware.fileSystem.createReadStream(
      path.resolve(pathName, 'index.html')
    );
    // å°†è¯¥æ–‡ä»¶è¾“å‡ºåˆ°viewsä¸‹
    const ws = await fs.createWriteStream(
      path.resolve(__dirname, '../views/index.html')
    );
    await rs.pipe(ws);
    await next();
  });

});

app.listen(port, () => {
  logger.trace(
    `\n==> ğŸŒ  Listening on port ${port}. Open up http://localhost:${port}/ in your browser.\n`
  );
});

```

#### æ€è€ƒï¼Ÿ
- æ˜¯å¦å¯ä»¥ä¸é€‚ç”¨webpackæ‰“åŒ…ç”Ÿæˆçš„jsä½œä¸ºæœåŠ¡å™¨å¯åŠ¨æ–‡ä»¶
    - å¯ä»¥ï¼Œç›´æ¥ä½¿ç”¨ts-nodeè¿è¡Œ nodemonç›‘å¬
    - ä½†æ˜¯ï¼Œéœ€è¦è§£å†³åŒæ„é¡¹ç›®æ¨¡å—åŒ–æ ·å¼æ–‡ä»¶é—®é¢˜ï¼Œéœ€è¦è‡ªå·±å†™ä¸€ä¸ªhooks

### ç”Ÿäº§é˜¶æ®µ

> ç›®çš„ï¼šæä¾›é«˜å¯ç”¨æœåŠ¡ä¸dockeré•œåƒæ–‡ä»¶

```json
{
"build": "npm-run-all --parallel build:app build:dll",
"build:app": "webpack --config ./config/webpack.prod.conf.ts",
"build:dll": "webpack --config ./config/webpack.dll.conf.ts",
"serve": "pm2 start ./ecosystem.config.js",
"stop": "pm2 stop ./dist/server/main.js",
"build:docker": "docker build -t ssr-service .",
"docker:run": "docker run -d -p 80:4000 ssr-service",
}
```
#### ç¬¬ä¸‰æ–¹ä¾èµ–æ‰“åŒ…

ä½¿ç”¨webacpkçš„dll-pluginå¯¹ç¬¬ä¸‰æ–¹ä¾èµ–è¿›è¡Œæ‰“åŒ…ï¼ˆå¦‚Reactç­‰ï¼‰ï¼Œç”Ÿæˆmanifest.jsonæ–‡ä»¶å’Œvendor.jsï¼Œå†ä½¿ç”¨DllReferencePluginè¯»å–é¢„å…ˆæ‰“åŒ…æ–‡ä»¶ï¼Œæœ‰ä»¥ä¸‹ä¼˜ç‚¹ï¼š
- å› ä¸ºç¬¬ä¸‰æ–¹ä¾èµ–æ˜¯é•¿æœŸç¨³å®šçš„ï¼Œä¸éœ€è¦æ ¹æ®åº”ç”¨ä¸šåŠ¡ä»£ç å˜åŒ–è€Œå˜åŒ–ï¼Œå¯ä»¥å•ç‹¬æ‰“åŒ…ï¼Œå¹¶ä¸”åšç¼“å­˜å¤„ç†
- å¦å¤–ï¼Œé¢„ç¼–è¯‘å¯ä»¥å¢å¼ºwebpackçš„æ‰“åŒ…é€Ÿåº¦

#### å‰ç«¯èµ„æºæ‰“åŒ…ï¼ˆéé‡ç‚¹ï¼‰
- ä½¿ç”¨æŒ‰æ¨¡å—åˆ’åˆ†ã€å‹ç¼©ã€æ··æ·†ã€gzã€hashåç¼“å­˜ç­‰æ–¹å¼ä¼˜åŒ–
- åç»­ï¼Œä½¿ç”¨nginxå®ç°é™æ€èµ„æºæœåŠ¡éƒ¨ç½²

#### ä½¿ç”¨pm2å’Œdocker

### å®ç°ç»†èŠ‚

#### ä»è®¿é—®è·¯å¾„ä½“ç°å®ç°ç»†èŠ‚

è®¿é—®http://localhost:4000/aboutmeä¸ºä¾‹å­

##### é¦–å±æ¸²æŸ“

ä»æµè§ˆå™¨åœ°å€æ è¾“å…¥http://localhost:4000/aboutme

SSRçš„reduxã€axiosã€routerä¸csrçš„éƒ½ä¸æ˜¯åŒä¸€ä¸ª

![SSR-timer](https://github.com/garry-mark/markdownImage/raw/master/ssr/SSR-timer.jpg)

```typescript
import * as React from 'react';
import * as ReactDOMServer from 'react-dom/server';

import { StaticRouter, StaticRouterContext } from 'react-router';
import { matchRoutes, renderRoutes } from 'react-router-config';
import RouteConfig from '@/browser/pages/router.config';

import { getStore } from '@/browser/store';
import { Provider } from 'react-redux';

interface WithStyleStaticRouterContext extends StaticRouterContext {
  styles?: string[];
  referUrl?: string;
}

function matchRouteConifg(url: string) {

  const branch = matchRoutes(RouteConfig, url);
  const withParamsDataLoaders = branch
    .map((route: any) => {
      return route.route.loadData ? { loadData: route.route.loadData, params: route.match.params } : null;
    })
    .filter((route) => route);
  return withParamsDataLoaders;
}

export default async (ctx: any, next: any) => {
  // è¿›å…¥ä¸­é—´ä»¶å
  // é¦–å…ˆæ ¡éªŒæ˜¯å¦åŒ¹é…é™æ€è·¯ç”±ï¼Œå¦‚æœåŒ¹é…åœ¨é™æ€è·¯ç”±
  // ä»è·¯ç”±ä¸­è·å–ç›¸å…³çš„æ‰€æœ‰Dataloaderæ–¹æ³•ï¼ˆå› ä¸ºå­˜åœ¨è·¯ç”±åµŒå¥—ï¼Œæ‰€ä»¥æœ‰å¤šä¸ªï¼‰
  const withParamsDataLoaders = matchRouteConifg(ctx.url);
  const regexp = /\w+\.\w+$/;
  const store = getStore();

  // åˆ¤æ–­è·¯ç”±æ˜¯å¦å±äºéæ‰©å±•åç»“å°¾ï¼Œè¿‡æ»¤èµ„æºæ–‡ä»¶è¯·æ±‚
  if (!regexp.test(ctx.url)) {
    // è®¾ç½®ä¸€ä¸ªä¸Šä¸‹æ–‡ç”¨äºåœ¨è·¯ç”±å¯¹åº”ç»„ä»¶æ¸²æŸ“æ—¶å€™ï¼Œè®°å½•ç»„ä»¶çš„æ ·å¼
    let context: WithStyleStaticRouterContext = { styles: [] };
    // éå†DataLoadersï¼Œä¼ å…¥æœåŠ¡å™¨ç«¯çš„storeï¼Œæ‰§è¡ŒloadDataæ–¹æ³•
    const promiseifyDataLoaders = withParamsDataLoaders
      .map((dataLoader: any) => dataLoader.loadData(store, dataLoader.params));

    try {
      // ç­‰å¾…æ‰€æœ‰loadDataæ–¹æ³•æ–¹æ³•æ‰§è¡Œå®Œæ¯•åï¼Œå³æ‰€æœ‰æ•°æ®éƒ½è®¾ç½®åˆ°storeå
      // ç”±äºSSRæ˜¯åŒæ­¥æ¸²æŸ“ï¼Œæ‰€æœ‰åªè¦æœ‰ä¸€ä¸ªæ•°æ®è·å–å¤±è´¥ï¼Œéƒ½ä¼šæ”¾å¼ƒSSR
      // é™¤éç”¨æˆ·å…³é—­æµè§ˆå™¨è„šæœ¬åŠŸèƒ½ï¼Œå¦åˆ™è¯¥æ¸²æŸ“æœ€ç»ˆèµ°CSR
      await Promise.all(promiseifyDataLoaders);
    } catch (e) {
      // å¦‚æœSSRå¤±è´¥ï¼Œä¼šè®°å½•èŒƒå›´æ­¤æ¬¡ssrçš„urlä¾¿äºé¡µé¢é‡æ–°å°è¯•ã€‚åªæœ‰ä¸æ”¯æŒCSR æƒ…å†µä¸‹å‡ºç°
      context = { ...context, referUrl: ctx.url };
      // æŠŠé¡µé¢åªå‘é‡æ–°å°è¯•é¡µé¢
      ctx.url = '/service-error';
      ctx.logger.error(`SSR Fail ${e.config && e.config.url} ( ${e.message} )`);
    }

    // æ ¹æ®ç›¸å…³çš„urlåŒ¹é…å¯¹åº”çš„è·¯ç”±ç»„ä»¶å’Œå·²ç»é¢„åŠ è½½æ•°æ®çš„storeè¿›è¡Œé™æ€æ¸²æŸ“ï¼Œç”Ÿæˆhtmlå½¢å¼çš„å­—ç¬¦ä¸²
    const markup = ReactDOMServer.renderToString(
      <Provider store={store}>
        <StaticRouter location={ctx.url} context={context}>
          {renderRoutes(RouteConfig)}
        </StaticRouter>
      </Provider>
    );

    // å°†storeè®°å½•åˆ°windowä¸‹ä¾¿äºCSRæ—¶å€™è·å¾—ä»¥åŠåˆå§‹åŒ–çš„store
    // æ ·å¼æ”¾åˆ°htmlä¸­ï¼Œæ˜¯åŠ è½½é¡µé¢æ—¶å€™å¯ä»¥å…ˆå‡ºæ ·å¼
    const template = {
      root: markup,
      state: JSON.stringify(store.getState()) || '',
      styles: context.styles ? context.styles.join('') : ''
    };

    // æ ¹æ®æ¸²æŸ“è·¯ç”±æ—¶å€™ï¼Œå„ä¸ªè·¯ç”±è®¾ç½®çš„è¿”å›ç ï¼Œæ§åˆ¶httpçŠ¶æ€ç 
    switch (context.statusCode) {
      default:
        await ctx.render('index', template);
        break;
      case 301:
      case 302:
        ctx.status = context.statusCode;
        ctx.redirect(context.url);
        break;
      case 404:
        ctx.status = context.statusCode;
        await ctx.render('index', template);
        break;
    }

  }
  await next();
};

```

##### é¦–å±æ¸²æŸ“åçš„å®¢æˆ·ç«¯æ¸²æŸ“

èŠ‚æµåˆ¤æ–­ï¼šç”±äºä»¥åŠè¿›è¡Œé¢„åŠ è½½æ•°æ®storeä¸­æœ‰æ•°æ®å­˜åœ¨ï¼Œåœ¨reactå®ŒæˆåŠ è½½å¯ä»¥äº¤äº’çš„è¿‡ç¨‹ä¸­ä¼šå‡ºå‘componentMountedï¼Œå³ä¸€èˆ¬æ•°æ®åŠ è½½çš„ç”Ÿå‘½å‘¨æœŸï¼Œè¿™æ—¶å€™éœ€è¦åˆ¤æ–­æ˜¯å¦å·²ç»æœ‰æ•°æ®ï¼Œå†è¿›è¡Œæ•°æ®è·å–ã€‚

é¦–å±æ¸²æŸ“åªåŠ è½½å¯¹åº”æ¨¡å—ç»„ä»¶çš„æ•°æ®ï¼Œå…¶ä»–é¡µé¢çš„æ•°æ®éœ€è¦åœ¨å…¶ä»–æ¨¡å—CSRæ—¶å€™åŠ è½½

#### å¿«é€Ÿä¸Šæ‰‹ä½“éªŒå®ç°ç»†èŠ‚

ä»¥aboutmeæ¨¡å—ä¸ºä¾‹å­

##### è®¾ç½®é™æ€è·¯ç”±

```
import { RouteConfig } from 'react-router-config';
import App from '@/browser/pages/app';
import AboutMe from '@/browser/pages/about-me';
import ArticleDetails from '@/browser/pages/article';
import ArticleList from '@/browser/pages/article-list';

import NotFound from '@/browser/components/status/notFound';
import ServiceError from '@/browser/components/status/serviceError';

export interface DigitizedRouteConfig extends RouteConfig {
  loadData?: (store: any, params: any) => void;
  path?: string;
  routes?: DigitizedRouteConfig[];
}

const RouteConfig: DigitizedRouteConfig[] = [
  {
    component: App,
    routes: [
      {
        component: AboutMe,
        path: '/aboutme',
        // æš´éœ²å®¹å™¨ç»„ä»¶çš„loadataæ–¹æ³•åˆ°æ­¤ï¼Œæ–¹ä¾¿è·¯ç”±åŒ¹é…æ—¶è·å–
        loadData: AboutMe.loadData
      },
      {
        component: ServiceError,
        path: '/service-error'
      },
      {
        component: NotFound
      }
    ]
  }
];

export default RouteConfig;
```
##### ç¼–å†™å®¹å™¨ç»„ä»¶

reactä¸­å®¹å™¨ç»„ä»¶éƒ½æ˜¯é€šè¿‡é«˜é˜¶ç»„ä»¶çš„æ–¹å¼ä¸ºUIç»„ä»¶æä¾›ç›¸å…³å¢å¼º
ä¸€èˆ¬ç»„ä»¶éƒ½åŒ…å«Loadableã€connectã€withRouterã€widthStyleç­‰è¿™å‡ ä¸ª

å…¶ä¸­widthStyleå°è£…äº†_getCssï¼Œåœ¨webpackæ‰“åŒ…æ˜¯èµ‹å€¼ç»™Styleå¯¹è±¡çš„æ–¹æ³•ç”¨äºè·å–åŸç”Ÿcsså­—ç¬¦ä¸²ï¼Œè¿™æ˜¯ä¸ºä»€ä¹ˆnodeç«¯ä½¿ç”¨webpackæ‰“åŒ…

å¦‚æœä½¿ç”¨å…¶ä»–æ–¹æ¡ˆåœ¨nodeä¸­æ·»åŠ css-moduleé’©å­ï¼ˆåŸç†å¢å¼ºrequriedå¤„ç†å…¶ä»–åç¼€ååŠŸèƒ½ï¼‰ï¼Œä½†æ˜¯ç”±äºcss-moduleé’©å­æ²¡æœ‰æä¾›_getCssç±»ä¼¼çš„æ–¹æ³•ï¼Œæ‰€æœ‰ä½¿ç”¨webpackæ‰“åŒ…ã€‚å› ä¸ºé¿å…ä½¿ç”¨webpackæ‰“åŒ…ï¼Œæœ‰åŠ©äºä½¿ç”¨åŸç”Ÿrequriedæ¨¡å—åŠ è½½çš„ä¼˜ç‚¹ï¼Œå³æ— éœ€æŠŠæ ·å¼æ‰“è¿›æœ€åçš„jsæ–‡ä»¶ä¸­ã€‚

```
import * as React from 'react';
import { withRouter } from 'react-router';

import actions from '@/browser/actions/aboutme';
import { connect } from 'react-redux';
import { bindActionCreators } from 'redux';

import withStyles from '@/browser/components/HOC/withStyles';
import * as style from './about-me.css';

import Loading from '@/browser/components/loading/';
import * as Loadable from 'react-loadable';

// å®ç°æ‡’åŠ è½½å’Œloadingæ•ˆæœ
const LoadableAboutMe = Loadable({
  loader: () => import('@/browser/pages/about-me/about-me'),
  loading: Loading
});

//
const ConnectAboutMe = connect(mapStateToProps, mapDispatchToProps)(LoadableAboutMe);

class AboutMe extends React.Component<any, any> {
  // SSRè·å–æ•°æ®çš„æ ¸å¿ƒ
  // ä¸ºä»€ä¹ˆå†™åœ¨è¿™é‡Œï¼Œå› ä¸ºæ–¹ä¾¿ç»‘å®šæ¯ä¸ªæ¨¡å—æ—¶å€™ï¼Œåœ¨é™æ€è·¯ç”±ä¸­å¯¼å‡º
  public static loadData(store: any): void {
    return store.dispatch(actions.getAboutme());
  }

  public render() {
    // reactä¸­ä½¿ç”¨è‡ªå®šä¹‰çš„é«˜é˜¶ç»„ä»¶æ—¶ï¼Œéœ€è¦æ³¨æ„propsçš„é€ä¼ 
    return <ConnectAboutMe {...this.props} />;
  }
}

function mapStateToProps(state: any) {
  return { aboutme: state.aboutme };
}

function mapDispatchToProps(dispatch: any) {
  return { actions: bindActionCreators(actions, dispatch) };
}

// why withStyles on here?
// because data and style muse be load before LoadableComponent
export default withStyles(style)(withRouter(AboutMe));

```

##### ç¼–å†™UIç»„ä»¶
```
import * as React from 'react';
import * as style from './about-me.css';

class AboutMe extends React.Component<any, any> {

  public componentDidMount() {
    // èŠ‚æµåˆ¤æ–­
    if (this.props && this.props.aboutme === null) { this.getAboutme(); }
  }

  public render() {
    const { aboutme } = this.props;
    const initAboutme = {
      avatar: '',
      chineseName: '',
      username: '',
      birthday: '',
      degree: '',
      company: '',
      jobTitle: '',
      hobby: [],
      email: ''
    };
    const {
      avatar = 'https://via.placeholder.com/400x400',
      chineseName = 'éº¦å¥è£',
      username = '',
      birthday = '1994-12-31',
      degree = 'Computer',
      company = 'Chinatelecom',
      jobTitle = 'Front-end engineer',
      hobby = [
        'bodybuilding',
        'swimming',
        'cooking',
        'surfing internet',
        'watching movie'
      ],
      email = ''
    } =
      aboutme || initAboutme;

    const [lastName, firstName] = username.split(' ');

    return (
      <section className={style.aboutMe}>
        <h2>About Me</h2>
        <h3>Base Info</h3>
        <p>
          My name is{' '}
          <a href={avatar} target="_blank" rel="noopener noreferrer">
            {lastName} {firstName}
          </a>{' '}
          ({chineseName}). You can call me {lastName}. I was born in{' '}
          {birthday && birthday.split('-')[0]}s.
        </p>
        <p>
          I have an {degree} degree. Now I am employed by {company} as an{' '}
          {jobTitle}.
        </p>
        <p>In spare time, I like {hobby && hobby.join(', ')}.</p>
        <h3>Concact Me</h3>

        <p>
          email: <a href={`mailto:${email}`}>{email}</a>
        </p>
      </section>
    );
  }
  private getAboutme = () => {
    const { actions } = this.props;
    actions.getAboutme().catch(() => {
      this.props.history.push('/service-error');
    });
  }
}

export default AboutMe;
```
### ä¼˜åŒ–ç©ºé—´
- å•å…ƒæµ‹è¯•ã€é›†æˆæµ‹è¯•ã€å‹åŠ›æµ‹è¯•
- å¼€å‘ç¯å¢ƒç›‘å¬æ··ä¹±é—®é¢˜ï¼Œè€ƒè™‘ts-nodeæ–¹æ¡ˆ
- ç”Ÿäº§ç¯å¢ƒnodeç¼–è¯‘ï¼Œè€ƒè™‘å•çº¯tsc
- çƒ­æ›¿æ¢æ¨¡å—ä¼˜åŒ–
- tsconfigä¹±æ··
- tslintæ— æ³•ä½¿ç”¨
